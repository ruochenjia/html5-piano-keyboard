<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<title>Piano</title>
		<style type="text/css">
* {
	margin: 0px;
	padding: 0px;
}

@font-face {
	font-family: "Ubuntu";
	font-style: normal;
	src: url("res/ubuntu.ttf") format("truetype");
}

@font-face {
	font-family: "Ubuntu Mono";
	font-style: normal;
	src: url("res/ubuntu-mono.ttf") format("truetype");
}

body {
	position: absolute;
	display: block;
	width: 100%;
	height: 100%;
	font-size: 14px;
	font-family: "Ubuntu";
	font-weight: 500;
	overflow: hidden;
}

keyboard-map {
	position: absolute;
	display: block;
	width: calc(100% - 100px);
	height: calc(50% - 100px);
	margin: 50px;
	outline-style: solid;
	outline-color: #000000;
	outline-width: 1px;
}
		</style>
    </head>
	<body>
		<keyboard-map id="keyboard"></keyboard-map>
		<script type="text/javascript">
"use strict";

// <![CDATA[
(() => {
// default error handler
window.onerror = (msg, src, lineno, colno, err) => {
	alert(msg, "Error", "images/error.png");
};


class HTMLKeyboardMap extends HTMLElement {
	constructor() {
		super();
		let shadow = this.attachShadow({mode: "closed"});

		shadow.innerHTML = `<style type="text/css">
row, f-row {
	position: relative;
	display: flex;
	width: fit-content;
	height: fit-content;
	margin: auto;
}

f-row {
	margin-bottom: 10px;
}

key, f-key {
	position: relative;
	display: block;
	width: 40px;
	height: 40px;
	text-align: center;
	line-height: 40px;
	font-size: 12px;
	font-weight: 500;
	color: #000000;
	box-sizing: border-box;
	background-color: #a0a0a0;
	border-style: solid;
	border-width: 2px;
	border-top-color: #f0f0f0;
	border-left-color: #f0f0f0;
	border-bottom-color: #101010;
	border-right-color: #101010;
}

f-key {
	height: 30px;
	line-height: 30px;
}

key[active] {
	border-top-color: #101010;
	border-left-color: #101010;
	border-bottom-color: #f0f0f0;
	border-right-color: #f0f0f0;
}
		</style>
		<f-row>
			<f-key display="Esc" width="1.153846"></f-key>
			<f-key display="F1" width="1.153846"></f-key>
			<f-key display="F2" width="1.153846"></f-key>
			<f-key display="F3" width="1.153846"></f-key>
			<f-key display="F4" width="1.153846"></f-key>
			<f-key display="F5" width="1.153846"></f-key>
			<f-key display="F6" width="1.153846"></f-key>
			<f-key display="F7" width="1.153846"></f-key>
			<f-key display="F8" width="1.153846"></f-key>
			<f-key display="F9" width="1.153846"></f-key>
			<f-key display="F10" width="1.153846"></f-key>
			<f-key display="F11" width="1.153846"></f-key>
			<f-key display="F12" width="1.153846"></f-key>
		</f-row>
		<row>
			<key n="\`" s="~"></key>
			<key n="1" s="!"></key>
			<key n="2" s="@"></key>
			<key n="3" s="#"></key>
			<key n="4" s="$"></key>
			<key n="5" s="%"></key>
			<key n="6" s="^"></key>
			<key n="7" s="&"></key>
			<key n="8" s="*"></key>
			<key n="9" s="("></key>
			<key n="0" s=")"></key>
			<key n="-" s="_"></key>
			<key n="=" s="+"></key>
			<key n="Backspace" s="Backspace" width="2"></key>
		</row>
		<row>
			<key n="Tab" s="Tab" width="1.5"></key>
			<key n="q" s="Q"></key>
			<key n="w" s="W"></key>
			<key n="e" s="E"></key>
			<key n="r" s="R"></key>
			<key n="t" s="T"></key>
			<key n="y" s="Y"></key>
			<key n="u" s="U"></key>
			<key n="i" s="i"></key>
			<key n="o" s="O"></key>
			<key n="p" s="P"></key>
			<key n="[" s="{"></key>
			<key n="]" s="}"></key>
			<key n="\\" s="|" width="1.5"></key>
		</row>
		<row>
			<key n="CapsLock" s="CapsLock" width="1.8" display="Caps Lock"></key>
			<key n="a" s="A"></key>
			<key n="s" s="S"></key>
			<key n="d" s="D"></key>
			<key n="f" s="F"></key>
			<key n="g" s="G"></key>
			<key n="h" s="H"></key>
			<key n="j" s="J"></key>
			<key n="k" s="K"></key>
			<key n="l" s="L"></key>
			<key n=";" s=":"></key>
			<key n="'" s="&quot;"></key>
			<key n="Enter" s="Enter" width="2.2"></key>
		</row>
		<row>
			<key n="Shift" s="Shift" width="2"></key>
			<key n="z" s="Z"></key>
			<key n="x" s="X"></key>
			<key n="c" s="C"></key>
			<key n="v" s="V"></key>
			<key n="b" s="B"></key>
			<key n="n" s="N"></key>
			<key n="m" s="M"></key>
			<key n="," s="&lt;"></key>
			<key n="." s="&gt;"></key>
			<key n="/" s="?"></key>
			<key n="Shift" s="Shift" width="3"></key>
		</row>
		<row>
			<key n="Control" s="Control" width="1.5" display="Ctrl"></key>
			<key n="Meta" s="Meta" width="1.5" display="Meta"></key>
			<key n="Alt" s="Alt" width="1.5" display="Alt"></key>
			<key n=" " s=" " width="6" display=" "></key>
			<key n="Alt" s="Alt" width="1.5" display="Alt"></key>
			<key n="Meta" s="Meta" width="1.5" display="Meta"></key>
			<key n="Control" s="Control" width="1.5" display="Ctrl"></key>
		</row>`;

		let shifted = false;
		let activeKeys = [];

		let fallback = (a, b) => {
			if (a == null)
				return b;
			return a;
		};

		let isActive = (key) => {
			for (let i = 0; i < activeKeys.length; i++)
			if (key == activeKeys[i])
				return true;
			return false;
		};

		let sendKeyEvent = (state, key) => {
			window.dispatchEvent(state ? new KeyboardEvent("keydown", { key: key }) : new KeyboardEvent("keyup", { key: key }));
		};

		let mapKey = (key, code) => {
			let map = this.map[code];
			if (map == null)
				return code;

			key.style.backgroundColor = "#d0d0d0";
			return map;
		};
		
		let render = () => {
			let rows = shadow.children;
			for (let i = 0; i < rows.length; i++) {
				let row = rows[i];
				let keys = row.children;
				for (let i = 0; i < keys.length; i++) {
					let key = keys[i];
					let normal = key.getAttribute("n");
					let shift = key.getAttribute("s");
					let code = shifted ? shift : normal;
					let mapped = mapKey(key, code);
					let width = fallback(key.getAttribute("width"), 1);
					let display = fallback(key.getAttribute("display"), mapped);

					if (isActive(code))
						key.setAttribute("active", "true");
					else key.removeAttribute("active");

					key.style.width = Math.round(40 * width) + "px";
					key.innerHTML = display;
					key.onmousedown = (e) => sendKeyEvent(true, code);
					key.onmouseup = (e) => sendKeyEvent(false, code);
				}
			}
		};

		Array.prototype.remove = function(element) {
			for (let i = 0; i < this.length; i++) {
				if (this[i] == element)
					this.splice(i, 1);
			}
		};

		window.addEventListener("keydown", (e) => {
			e.preventDefault();

			if (e.keyCode == 16)
				shifted = true;
			else {
				let k = e.key;
				if (!activeKeys.includes(k))
					activeKeys.push(k);
			}

			render();
			return true;
		}, false);

		window.addEventListener("keyup", (e) => {
			e.preventDefault();

			if (e.keyCode == 16)
				shifted = false;
			else activeKeys.remove(e.key);

			render();
			return true;
		}, false);

		render();

		this.render = render;
		this.shadow = shadow;
	}

	set map(_) {
		this._map = _;
		this.render();
	}

	get map() {
		let m = this._map;
		if (m == null)
			return {};
		return m;
	}
}
customElements.define("keyboard-map", HTMLKeyboardMap, {});



let keyboard = document.getElementById("keyboard");
let audioContext = new AudioContext();
let map = {
	"`": "B2",
	"~": "C3",
	"1": "C3",
	"!": "C#3",
	"2": "D3",
	"@": "D#3",
	"3": "E3",
	"#": "F3",
	"4": "F3",
	"$": "F#3",
	"5": "G3",
	"%": "G#3",
	"6": "A3",
	"^": "A#3",
	"7": "B3",
	"&": "C4",
	"q": "C4",
	"Q": "C#4",
	"w": "D4",
	"W": "D#4",
	"e": "E4",
	"E": "F4",
	"r": "F4",
	"R": "F#4",
	"t": "G4",
	"T": "G#4",
	"y": "A4",
	"Y": "A#4",
	"u": "B4",
	"U": "C5",
	"a": "C5",
	"A": "C#5",
	"s": "D5",
	"S": "D#5",
	"d": "E5",
	"D": "F5",
	"f": "F5",
	"F": "F#5",
	"g": "G5",
	"G": "G#5",
	"h": "A5",
	"H": "A#5",
	"j": "B5",
	"J": "C6",
	"z": "C6",
	"Z": "C#6",
	"x": "D6",
	"X": "D#6",
	"c": "E6",
	"C": "F6",
	"v": "F6",
	"V": "F#6",
	"b": "G6",
	"B": "G#6",
	"n": "A6",
	"N": "A#6",
	"m": "B6",
	"M": "C7"
};
keyboard.map = map;

let Piano = (() => {
	let activeNotes = [];

	function _a(a, b) {
		a = c(a);
		b = (b - 4) * 12;
		a += b;
		a *= 100;
		return a;
	}

	function c(a) {
		switch(a) {
			case "C":
				return 0;
			case "C#":
				return 1;
			case "D":
				return 2;
			case "D#":
				return 3;
			case "E":
				return 4;
			case "F":
				return 5;
			case "F#":
				return 6;
			case "G":
				return 7;
			case "G#":
				return 8;
			case "A":
				return 9;
			case "A#":
				return 10;
			case "B":
				return 11;
			default:
				throw "Invalid value " + a;
		}
	}

	function parseNote(note = "") {
		switch(note.length) {
			case 2:
				let h = note[0];
				let o = note[1];
				return _a(h, o);
			case 3:
				let l = note[0] + note[1];
				let v = note[2];
				return _a(l, v);
			default:
				throw "Invalid note value " + note;
		}
	}

	function makeSound(key) {
		let oscillator = audioContext.createOscillator();
		oscillator.type = "triangle";
		oscillator.frequency.value = 440;
		oscillator.detune.value = key;
		oscillator.connect(audioContext.destination);
		oscillator.start();
		return oscillator;
	}

	function indexOfNote(note) {
		for (let i = 0; i < activeNotes.length; i++) {
			let n = activeNotes[i];
			if (n.note == note)
				return i;
		}
		return -1;
	}

	function play(note) {
		// check to prevent duplicated
		if (indexOfNote(note) < 0) {
			let sound = {
				note: note,
				oscillator : makeSound(parseNote(note))
			};
			activeNotes.push(sound);
		}
	}

	function stop(note) {
		let n = activeNotes[indexOfNote(note)];
		n.oscillator.stop();
		activeNotes.remove(n);
	}

	return {
		play: play,
		stop: stop,

		get activeNotes() {
			return activeNotes;
		}
	};
})();

window.addEventListener("keydown", (e) => {
	let m = map[e.key];
	if (m != null) {
		Piano.play(m);
	}
	return true;
}, false);

window.addEventListener("keyup", (e) => {
	let m = map[e.key];
	if (m != null) {
		Piano.stop(m);
	}
	return true;
}, false);

})();
		</script>
	</body>
</html>